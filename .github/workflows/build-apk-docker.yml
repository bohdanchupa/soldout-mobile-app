name: Build APKs with Docker

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'both'
        type: choice
        options:
          - test
          - prod
          - both

jobs:
  build-test-apk:
    name: Build TEST APK
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type == 'test' || github.event.inputs.build_type == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build web assets in Docker (Node 14 + Sass configured)
        run: |
          # Create Dockerfile with proper sass setup
          cat > Dockerfile.build << 'EOF'
          FROM node:14-alpine
          WORKDIR /app
          
          # Install build tools
          RUN apk add --no-cache python3 make g++ git
          
          # Copy everything
          COPY . .
          
          # Install dependencies (EXACTLY like local Docker that works!)
          RUN npm install --ignore-scripts && rm -rf node_modules/node-sass
          
          # Install src-cordova deps (also with --ignore-scripts)
          RUN cd src-cordova && npm install --ignore-scripts && cd ..
          
          # Build command
          CMD ["sh", "-c", "npx quasar build"]
          EOF
          
          # Build Docker image
          docker build -f Dockerfile.build -t soldout-builder .
          
          # Run build and extract dist folder
          docker run --name temp-builder soldout-builder
          docker cp temp-builder:/app/dist ./dist
          docker rm temp-builder
          
          # Verify dist was created
          ls -la dist/spa/

      - name: Setup Java 17 (required by Gradle 9.2.0)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Cordova
        run: npm install -g cordova@10.0.0

      - name: Install src-cordova dependencies
        run: |
          cd src-cordova
          npm install
          cd ..

      - name: Copy web assets to Cordova www
        run: |
          mkdir -p src-cordova/www
          cp -r dist/spa/* src-cordova/www/
          ls -la src-cordova/www/

      - name: Build Android APK  
        run: |
          cd src-cordova
          # Use Cordova Android 12.x (latest, should support Gradle 9.x)
          cordova platform add android@latest
          cordova build android --debug
          cd ..

      - name: Rename and upload TEST APK
        run: |
          mkdir -p build-output
          cp src-cordova/platforms/android/app/build/outputs/apk/debug/app-debug.apk build-output/soldout-test-debug.apk

      - name: Upload TEST APK
        uses: actions/upload-artifact@v4
        with:
          name: soldout-test-apk
          path: build-output/soldout-test-debug.apk
          retention-days: 30

  build-prod-apk:
    name: Build PROD APK
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type == 'prod' || github.event.inputs.build_type == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Switch to PROD environment
        run: |
          cat > src/api/endpoints.js << 'EOF'
          // Production
          const serviceUrl = 'https://z.soldout.com.ua'

          export const serviceURL = serviceUrl

          export const epToken = `${serviceUrl}/main-service/oauth/token`
          export const epLogin = `${serviceUrl}/main-service/user/get`
          export const epAllOrders = `${serviceUrl}/main-service/api/find-orders-by-organizator`
          export const epAllTickets = `${serviceUrl}/main-service/api/find-tickets-by-organizator-short`
          export const epSummOfPeriod = `${serviceUrl}/main-service/api/find-sum-by-organizator`
          export const epEvents = `${serviceUrl}/main-service/api/find-bought-events-by-organizator`
          export const epEventsToday = `${serviceUrl}/main-service/api/find-bought-events-and-info-by-organizator`
          export const epEventsArchive = `${serviceUrl}/main-service/api/find-archive-events-by-organizator`
          export const epEventInSum = `${serviceUrl}/main-service/api/find-sum-by-event`
          export const epEventInCount = `${serviceUrl}/main-service/api/find-count-by-event`
          export const epEventDetailsTable = `${serviceUrl}/main-service/api/find-color-price-by-event`
          export const epEventDetailsTableForDate = `${serviceUrl}/main-service/api/find-color-price-by-event-and-date`
          export const epStatisticInEntryScreen = `${serviceUrl}/main-service/api/find-events-by-organizator-main-short-info`
          export const epEventSoldShortInfo = `${serviceUrl}/main-service/api/find-events-by-organizator-sold-short-info`
          EOF

      - name: Build web assets in Docker (Node 14 + Sass configured)
        run: |
          # Create Dockerfile with proper sass setup
          cat > Dockerfile.build << 'EOF'
          FROM node:14-alpine
          WORKDIR /app
          
          # Install build tools
          RUN apk add --no-cache python3 make g++ git
          
          # Copy everything
          COPY . .
          
          # Install dependencies (EXACTLY like local Docker that works!)
          RUN npm install --ignore-scripts && rm -rf node_modules/node-sass
          
          # Install src-cordova deps (also with --ignore-scripts)
          RUN cd src-cordova && npm install --ignore-scripts && cd ..
          
          # Build command
          CMD ["sh", "-c", "npx quasar build"]
          EOF
          
          # Build Docker image
          docker build -f Dockerfile.build -t soldout-builder .
          
          # Run build and extract dist folder
          docker run --name temp-builder soldout-builder
          docker cp temp-builder:/app/dist ./dist
          docker rm temp-builder
          
          # Verify dist was created
          ls -la dist/spa/

      - name: Setup Java 17 (required by Gradle 9.2.0)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Cordova
        run: npm install -g cordova@10.0.0

      - name: Install src-cordova dependencies
        run: |
          cd src-cordova
          npm install
          cd ..

      - name: Copy web assets to Cordova www
        run: |
          mkdir -p src-cordova/www
          cp -r dist/spa/* src-cordova/www/
          ls -la src-cordova/www/

      - name: Build Android APK  
        run: |
          cd src-cordova
          # Use Cordova Android 12.x (latest, should support Gradle 9.x)
          cordova platform add android@latest
          cordova build android --debug
          cd ..

      - name: Rename and upload PROD APK
        run: |
          mkdir -p build-output
          cp src-cordova/platforms/android/app/build/outputs/apk/debug/app-debug.apk build-output/soldout-prod-debug.apk

      - name: Upload PROD APK
        uses: actions/upload-artifact@v4
        with:
          name: soldout-prod-apk
          path: build-output/soldout-prod-debug.apk
          retention-days: 30
